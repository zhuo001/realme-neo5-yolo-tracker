name: build-apk

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Accept Android licenses
      run: yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
      
    - name: Install specific NDK version
      run: |
        # Install NDK 27.3.13750724 to match system
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "ndk;27.3.13750724" || true
        # Also install NDK bundle as fallback
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "ndk-bundle" || true
        
    - name: Download and setup NCNN library
      run: |
        echo "Downloading NCNN Android library..."
        
        # Download with retry mechanism
        for i in {1..3}; do
          wget https://github.com/Tencent/ncnn/releases/download/20240102/ncnn-20240102-android.zip && break
          echo "Download attempt $i failed, retrying..."
          sleep 5
        done
        
        if [ ! -f "ncnn-20240102-android.zip" ]; then
          echo "Failed to download NCNN library after 3 attempts"
          exit 1
        fi
        
        echo "Download successful, extracting..."
        unzip -q ncnn-20240102-android.zip
        
        # Verify extraction
        if [ ! -d "ncnn-20240102-android" ]; then
          echo "Failed to extract NCNN library"
          exit 1
        fi
        
        # Create NCNN directory structure
        mkdir -p ncnn-android/include
        mkdir -p ncnn-android/lib/android/arm64-v8a
        
        # Copy header files
        if [ -d "ncnn-20240102-android/arm64-v8a/include" ]; then
          cp -r ncnn-20240102-android/arm64-v8a/include/* ncnn-android/include/
        else
          echo "Warning: NCNN include directory not found"
          ls -la ncnn-20240102-android/
          ls -la ncnn-20240102-android/arm64-v8a/
        fi
        
        # Copy static library
        if [ -f "ncnn-20240102-android/arm64-v8a/lib/libncnn.a" ]; then
          cp ncnn-20240102-android/arm64-v8a/lib/libncnn.a ncnn-android/lib/android/arm64-v8a/
        else
          echo "Warning: NCNN static library not found"
          find ncnn-20240102-android -name "*.a" -type f
        fi
        
        echo "NCNN library setup completed:"
        ls -la ncnn-android/
        ls -la ncnn-android/include/ 2>/dev/null || echo "No include directory"
        ls -la ncnn-android/lib/android/arm64-v8a/ 2>/dev/null || echo "No lib directory"
        
    - name: Verify NCNN setup
      run: |
        echo "Verifying NCNN library setup..."
        
        # Check if directories exist
        if [ ! -d "ncnn-android" ]; then
          echo "ERROR: ncnn-android directory not found"
          exit 1
        fi
        
        if [ ! -d "ncnn-android/include" ]; then
          echo "ERROR: ncnn-android/include directory not found"
          exit 1
        fi
        
        if [ ! -f "ncnn-android/lib/android/arm64-v8a/libncnn.a" ]; then
          echo "ERROR: libncnn.a not found"
          echo "Available files in lib directory:"
          find ncnn-android -name "*.a" -type f 2>/dev/null || echo "No .a files found"
          exit 1
        fi
        
        # Check file sizes
        echo "NCNN library file sizes:"
        du -h ncnn-android/lib/android/arm64-v8a/libncnn.a
        echo "Header files count:"
        find ncnn-android/include -name "*.h" | wc -l
        
        echo "✅ NCNN setup verification completed successfully"
        
    - name: Setup Gradle with network retry
      run: |
        mkdir -p ~/.gradle
        echo "org.gradle.daemon=false" >> ~/.gradle/gradle.properties
        echo "org.gradle.parallel=true" >> ~/.gradle/gradle.properties
        echo "org.gradle.jvmargs=-Xmx2048m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8" >> ~/.gradle/gradle.properties
        echo "org.gradle.configureondemand=true" >> ~/.gradle/gradle.properties
      
    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Download and setup compatible Gradle
      run: |
        # Download Gradle 8.0 for better Java 17 compatibility
        wget https://services.gradle.org/distributions/gradle-8.0-bin.zip
        unzip -q gradle-8.0-bin.zip
        export PATH=$PWD/gradle-8.0/bin:$PATH
        
        # Create wrapper with specific version
        gradle wrapper --gradle-version 8.0 --no-daemon
        chmod +x gradlew
        
        # Verify version
        ./gradlew --version
        
    - name: Create local.properties with retry
      run: |
        echo "sdk.dir=$ANDROID_HOME" > local.properties
        # Try to set NDK path to the installed version
        if [ -d "$ANDROID_HOME/ndk/27.3.13750724" ]; then
          echo "ndk.dir=$ANDROID_HOME/ndk/27.3.13750724" >> local.properties
        elif [ -d "$ANDROID_HOME/ndk-bundle" ]; then
          echo "ndk.dir=$ANDROID_HOME/ndk-bundle" >> local.properties
        elif [ -n "$ANDROID_NDK_ROOT" ]; then
          echo "ndk.dir=$ANDROID_NDK_ROOT" >> local.properties
        fi
        cat local.properties
        
    - name: Debug project structure before build
      run: |
        echo "🔍 Project structure debug:"
        echo "Current directory: $(pwd)"
        echo "NCNN directory exists: $(test -d ncnn-android && echo 'YES' || echo 'NO')"
        echo "CMakeLists.txt content:"
        cat app/src/main/cpp/CMakeLists.txt | grep -A 10 -B 2 "NCNN"
        echo ""
        echo "Project file structure:"
        find . -type f -name "*.cpp" -o -name "*.h" -o -name "CMakeLists.txt" | head -20
        echo ""
        echo "NCNN files:"
        ls -la ncnn-android/ 2>/dev/null || echo "No ncnn-android directory"
        
    - name: Clean project
      run: |
        if [ -f gradlew ]; then
          ./gradlew clean --no-daemon --stacktrace
        else
          gradle clean --no-daemon --stacktrace
        fi
        
    - name: Build Debug APK with retry
      run: |
        GRADLE_CMD="gradle"
        if [ -f gradlew ]; then
          GRADLE_CMD="./gradlew"
        fi
        
        for i in {1..3}; do
          $GRADLE_CMD assembleDebug --no-daemon --stacktrace --offline || $GRADLE_CMD assembleDebug --no-daemon --stacktrace
          if [ $? -eq 0 ]; then break; fi
          echo "Attempt $i failed, retrying..."
          sleep 10
        done
      
    - name: Build Release APK with retry
      run: |
        GRADLE_CMD="gradle"
        if [ -f gradlew ]; then
          GRADLE_CMD="./gradlew"
        fi
        
        for i in {1..3}; do
          $GRADLE_CMD assembleRelease --no-daemon --stacktrace --offline || $GRADLE_CMD assembleRelease --no-daemon --stacktrace
          if [ $? -eq 0 ]; then break; fi
          echo "Attempt $i failed, retrying..."
          sleep 10
        done
        
    - name: List APK files
      run: |
        find app/build/outputs/apk -name "*.apk" -type f
        
    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: realme-neo5-yolo-debug-apk
        path: app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30
        
    - name: Upload Release APK
      uses: actions/upload-artifact@v4
      with:
        name: realme-neo5-yolo-release-apk
        path: app/build/outputs/apk/release/app-release.apk
        retention-days: 30
        
    - name: Build Summary and Auto-Complete
      run: |
        echo "🎉 Android APK构建完成！"
        echo "📱 为Realme Neo 5 150W设备构建的YOLO跟踪器APK已准备就绪"
        echo ""
        echo "📦 构建产物:"
        echo "  • Debug APK: realme-neo5-yolo-debug-apk"
        echo "  • Release APK: realme-neo5-yolo-release-apk"
        echo ""
        echo "⬇️ 下载方式:"
        echo "  1. 点击Actions页面上的工作流运行"
        echo "  2. 在Artifacts部分下载APK文件"
        echo "  3. 传输到Realme Neo 5 150W设备并安装"
        echo ""
        echo "✅ 构建流程已完成，传输完成后将自动关闭"
        echo ""
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo "🏁 构建任务完成 - 所有APK文件已上传至Artifacts"
        echo "🔒 工作流程已结束，终端将自动关闭以释放资源"
        echo "📤 传输完成，任务结束，窗口自动退出"
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        
        # 标记构建完成
        echo "BUILD_COMPLETE=true" >> $GITHUB_ENV
        echo "::notice title=Build Complete::Android APK构建已完成，可以下载APK文件"
